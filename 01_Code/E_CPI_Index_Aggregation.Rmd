

The following is the 5 pillar 

```{r}
library(readxl)
library(dplyr)
library(purrr)
library(writexl)


df <- read_excel("C:/Users/AHMAD/OneDrive/UNDPNYCINDICES/Original_Cooling_Index/data_latest.xlsx")
df <- df[, c(1, 2, 8, 10)]
df <- df %>% na.omit()

df_count <- df %>% group_by(CODE) %>% summarise(count = n())
listy <- df_count$CODE[df_count$count >= 25]
df <- df %>% filter(CODE %in% listy)


pillar_map <- list(
  P1 = c("Humidity", "Temperature", "WB_CCKP_HD45"), # Climatic Exposure
  P2 = c("Electricity generation-Clean-%", "EG.ELC.ACCS.UR.ZS", "EG.ELC.ACCS.RU.ZS",
         "EG.ELC.LOSS.ZS"),
  P3 = c("building_standards", "Hascoolingplan"), # Institutional & Regulatory
  P4 = c("Access to finance", "Skills", "Industry activity", 
         "Research and Development", "Energy_efficiency_mitigation_financing","WB_RISE_EE_FMEE"), # Economic
  P5 = c("ICT", "SPI.D3.13.CLMT", "SPI.D3.7.ENRG", "SPI.D3.11.CITY", 
         "SPI.D3.1.POV", "SPI.D3.10.NEQL", "SPI.D3.5.GEND", "SPI.DIM1.5.INDEX", "Built environmentOverall score",
         "EnergyOverall score") # Digital & Data
)

pillar_weights <- c(P1 = 0.15, P2 = 0.30, P3 = 0.20, P4 = 0.20, P5 = 0.15)

within_weights <- list(

  P1 = c(0.3, 0.5, 0.2),  
  # (Humidity, Temperature, WB_CCKP_HD45)

  P2 = c(0.30, 0.25, 0.25, 0.20),
  # (Electricity generation-Clean-%, EG.ELC.ACCS.UR.ZS, EG.ELC.ACCS.RU.ZS, EG.ELC.LOSS.ZS)

  # Equal importance for building standards and national/subnational cooling plans.
  P3 = c(0.5, 0.5),
  # (building_standards, Hascoolingplan)

  P4 = c(0.25, 0.15, 0.15, 0.20, 0.15, 0.10),
  # (Access to finance, Skills, Industry activity, Research and Development,
  #  Energy_efficiency_mitigation_financing, WB_RISE_EE_FMEE)

  P5 = c(0.20, 0.10, 0.10, 0.08, 0.08, 0.08, 0.06, 0.10, 0.10, 0.10)
  # (ICT, SPI.D3.13.CLMT, SPI.D3.7.ENRG, SPI.D3.11.CITY, SPI.D3.1.POV,
  #  SPI.D3.10.NEQL, SPI.D3.5.GEND, SPI.DIM1.5.INDEX, Built environmentOverall score,
  #  EnergyOverall score)
)



lower_is_better <- c("EG.ELC.LOSS.ZS", "Humidity", "Temperature", "WB_CCKP_HD45")
year_cols <- as.character(c(2020,2022))

df_norm <- df %>%
  group_by(Indicator) %>%
  mutate(across(all_of(year_cols), ~ {
    min_val <- min(pick(all_of(year_cols)), na.rm = TRUE)
    max_val <- max(pick(all_of(year_cols)), na.rm = TRUE)
    norm_val <- (.-min_val) / (max_val - min_val)
    if (unique(Indicator) %in% lower_is_better) norm_val <- 1 - norm_val
    norm_val
  })) %>%
  ungroup()


get_pillar_score <- function(df, indicators, weights, year_cols) {
  df %>%
    filter(Indicator %in% indicators) %>%
    mutate(weight = rep(weights, each = n() / length(weights))) %>%
    group_by(CODE) %>%
    summarise(across(all_of(year_cols), ~ weighted.mean(.x, weight, na.rm = TRUE))) %>%
    ungroup()
}


pillar_scores <- list()
for (p in names(pillar_map)) {
  pillar_scores[[p]] <- get_pillar_score(df_norm, pillar_map[[p]], within_weights[[p]], year_cols)
  names(pillar_scores[[p]])[2:(length(year_cols)+1)] <- paste0(year_cols, "_", p)
}


final_df <- reduce(pillar_scores, full_join, by = "CODE")


for (year in year_cols) {
  final_df[[paste0(year, "_CoolingIndex")]] <-
    (final_df[[paste0(year, "_P1")]] * pillar_weights["P1"]) +
    (final_df[[paste0(year, "_P2")]] * pillar_weights["P2"]) +
    (final_df[[paste0(year, "_P3")]] * pillar_weights["P3"]) +
    (final_df[[paste0(year, "_P4")]] * pillar_weights["P4"]) +
    (final_df[[paste0(year, "_P5")]] * pillar_weights["P5"])
}


write_xlsx(final_df, "C:/Users/AHMAD/OneDrive/UNDPNYCINDICES/Original_Cooling_Index/Weighted_Cooling_Index_5Pillars.xlsx")
write_xlsx(df_norm, "C:/Users/AHMAD/OneDrive/UNDPNYCINDICES/Original_Cooling_Index/df_norm_5Pillars.xlsx")





```

